import time
import traceback
from threading import Thread

from config import CONFIG
from src.logger import logger
from src.process_email_inbox import process_email_inbox_simple, EmailMonitor
from src.process_output_ocr import process_output_ocr
from src.folder_watcher import FolderWatcher


def main() -> None:
    """
    –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–Ω–æ–≥–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ø–æ—á—Ç—ã –∏ –ø–∞–ø–æ–∫.

    –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç EmailMonitor –∏ FolderWatcher –≤ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –ø–æ—Ç–æ–∫–∞—Ö,
    –æ–±–µ—Å–ø–µ—á–∏–≤–∞—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—É—é —Ä–∞–±–æ—Ç—É. –õ–æ–≥–∏—Ä—É–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∏ —É–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ–º
    –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–∏–≥–Ω–∞–ª–∞ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è.

    Raises:
        KeyboardInterrupt: –ü—Ä–∏ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º (Ctrl+C).
    """
    # –õ–æ–≥–∏—Ä—É–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º —Ä–∞–±–æ—Ç—ã.
    logger.info(CONFIG.display_config())

    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è EmailMonitor
    email_monitor = EmailMonitor(
        email_user=CONFIG.EMAIL_ADDRESS,
        email_pass=CONFIG.EMAIL_PASSWORD,
        imap_server=CONFIG.imap_server,
        imap_port=CONFIG.imap_port
    )

    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è FolderWatcher —Å callback –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ OCR-—Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    folder_watcher = FolderWatcher(
        folder_path=CONFIG.OUT_OCR_FOLDER,
        callback=lambda: process_output_ocr(
            email_user=CONFIG.EMAIL_ADDRESS,
            email_pass=CONFIG.EMAIL_PASSWORD,
            smtp_server=CONFIG.smtp_server,
            smtp_port=CONFIG.smtp_port,
        )
    )

    # –°–æ–∑–¥–∞–µ–º –ø–æ—Ç–æ–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –º–æ–Ω–∏—Ç–æ—Ä–∞
    email_thread = Thread(target=email_monitor.monitor, name="EmailMonitor")
    folder_thread = Thread(target=folder_watcher.monitor, name="FolderWatcher")

    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ—Ç–æ–∫–∏ –∫–∞–∫ –¥–µ–º–æ–Ω—ã, —á—Ç–æ–±—ã –æ–Ω–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≤–µ—Ä—à–∞–ª–∏—Å—å –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞
    email_thread.daemon = True
    folder_thread.daemon = True

    try:
        # –ó–∞–ø—É—Å–∫–∞–µ–º –ø–æ—Ç–æ–∫–∏
        email_thread.start()
        folder_thread.start()
        logger.info("üîî –ó–∞–ø—É—â–µ–Ω—ã –æ—Ç–¥–µ–ª—å–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ø–æ—á—Ç—ã –∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ OUT_OCR")

        # –û—Å–Ω–æ–≤–Ω–æ–π –ø–æ—Ç–æ–∫ –æ–∂–∏–¥–∞–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, —á–µ—Ä–µ–∑ Ctrl+C)
        while True:
            time.sleep(1)  # –ù–µ–±–æ–ª—å—à–∞—è –ø–∞—É–∑–∞ –¥–ª—è —Å–Ω–∏–∂–µ–Ω–∏—è –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ CPU
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ—Ç–æ–∫–∏ –∂–∏–≤—ã (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –∏–ª–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π)
            if not email_thread.is_alive():
                logger.error("‚õî –ü–æ—Ç–æ–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ø–æ—á—Ç—ã –∑–∞–≤–µ—Ä—à–∏–ª—Å—è –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–æ")
                break
            if not folder_thread.is_alive():
                logger.error("‚õî –ü–æ—Ç–æ–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ø–∞–ø–æ–∫ –∑–∞–≤–µ—Ä—à–∏–ª—Å—è –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–æ")
                break

    except KeyboardInterrupt:
        logger.info("üîî –ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è, –æ–∂–∏–¥–∞–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø–æ—Ç–æ–∫–æ–≤")

    except Exception as e:
        logger.error(f"‚õî –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–æ–≥—Ä–∞–º–º—ã: {e}\n{traceback.format_exc()}")

    finally:
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –¥–ª—è EmailMonitor –∏ FolderWatcher
        email_monitor.stop()
        folder_watcher.stop()
        # –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø–æ—Ç–æ–∫–æ–≤ (–¥–µ–º–æ–Ω—ã –∑–∞–≤–µ—Ä—à–∞—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –Ω–æ –∂–¥–µ–º –¥–ª—è —á–∏—Å—Ç–æ—Ç—ã)
        email_thread.join(timeout=5.0)
        folder_thread.join(timeout=5.0)
        logger.info("üîî –ü—Ä–æ–≥—Ä–∞–º–º–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞")


def main_fallback() -> None:
    """–ó–∞–ø—É—Å–∫–∞–µ—Ç —É–ø—Ä–æ—â–µ–Ω–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–æ—á—Ç—ã –∏ –ø–∞–ø–æ–∫ –≤ –∞–≤–∞—Ä–∏–π–Ω–æ–º —Ä–µ–∂–∏–º–µ.

    –§—É–Ω–∫—Ü–∏—è –≤—ã–ø–æ–ª–Ω—è–µ—Ç –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É –≤—Ö–æ–¥—è—â–∏—Ö –ø–∏—Å–µ–º –∏ —Ñ–∞–π–ª–æ–≤ –ø–æ—Å–ª–µ OCR
    –≤ –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–º —Ü–∏–∫–ª–µ —Å –∑–∞–¥–∞–Ω–Ω–æ–π –ø–∞—É–∑–æ–π –º–µ–∂–¥—É –∏—Ç–µ—Ä–∞—Ü–∏—è–º–∏. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ –∑–∞–ø–∞—Å–Ω–æ–π
    –≤–∞—Ä–∏–∞–Ω—Ç –ø—Ä–∏ —Å–±–æ—è—Ö –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –º–µ—Ö–∞–Ω–∏–∑–º–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ (EmailMonitor –∏ FolderWatcher).
    –ö–∞–∂–¥—ã–π —ç—Ç–∞–ø (–ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—á—Ç—ã –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤) –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫,
    —á—Ç–æ–±—ã –∏—Å–∫–ª—é—á–µ–Ω–∏—è –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞–ª–∏ —Ü–∏–∫–ª.

    –õ–æ–≥–∏—Ä—É–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ, –Ω–∞—á–∞–ª–æ –∫–∞–∂–¥–æ–≥–æ —ç—Ç–∞–ø–∞ –∏ –æ—à–∏–±–∫–∏, –µ—Å–ª–∏ –æ–Ω–∏ –≤–æ–∑–Ω–∏–∫–∞—é—Ç.
    –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø—Ä–∏ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º (Ctrl+C).

    Returns:
        NoReturn: –§—É–Ω–∫—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ –∏ –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ,
            –∑–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ–º —Å–ª—É—á–∞–µ–≤ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è.

    Raises:
        KeyboardInterrupt: –ü—Ä–∏ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º (Ctrl+C), —á—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç
            –∫ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–º—É –∑–∞–≤–µ—Ä—à–µ–Ω–∏—é.
    """
    # –õ–æ–≥–∏—Ä—É–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –∏ –∫–æ–Ω—Ç—Ä–æ–ª—è
    logger.info(CONFIG.display_config())
    logger.info("–ó–∞–ø—É—â–µ–Ω —É–ø—Ä–æ—â–µ–Ω–Ω—ã–π —Ä–µ–∂–∏–º –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ (fallback)")

    try:
        while True:
            try:
                # –≠–¢–ê–ü 1:
                # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –ø–æ—á—Ç–æ–≤–æ–º —è—â–∏–∫–µ.
                # –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –≤–ª–æ–∂–µ–Ω–∏–π –∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –∏–∑ –∫–∞–∂–¥–æ–≥–æ –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
                process_email_inbox_simple(
                    email_user=CONFIG.EMAIL_ADDRESS,
                    email_pass=CONFIG.EMAIL_PASSWORD,
                    imap_server=CONFIG.imap_server,
                    imap_port=CONFIG.imap_port,
                )

                # –≠–¢–ê–ü 2:
                # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ—Å–ª–µ OCR
                # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π —Å —Ñ–∞–π–ª–∞–º–∏ –≤ OUT_OCR
                process_output_ocr(
                    email_user=CONFIG.EMAIL_ADDRESS,
                    email_pass=CONFIG.EMAIL_PASSWORD,
                    smtp_server=CONFIG.smtp_server,
                    smtp_port=CONFIG.smtp_port,
                )

            except Exception as e:
                # –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É, –Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ü–∏–∫–ª, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å
                logger.error(f"–û—à–∏–±–∫–∞ –≤ —É–ø—Ä–æ—â–µ–Ω–Ω–æ–º —Ä–µ–∂–∏–º–µ: {e}\n{traceback.format_exc()}")

            # –ü–∞—É–∑–∞ –º–µ–∂–¥—É –∏—Ç–µ—Ä–∞—Ü–∏—è–º–∏
            time.sleep(5)

    except KeyboardInterrupt:
        logger.info("–£–ø—Ä–æ—â–µ–Ω–Ω—ã–π —Ä–µ–∂–∏–º –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º")
        raise  # –í—ã–∑—ã–≤–∞–µ–º –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è –≤—ã—Ö–æ–¥–∞


# --- –û—Ç–¥–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ –∫–∞–∂–¥–æ–≥–æ –º–æ–¥—É–ª—è ---

def test_email_monitor() -> None:
    """–ó–∞–ø—É—Å–∫–∞–µ—Ç –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–π –ø–æ—á—Ç—ã –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –æ—Ç–ª–∞–¥–∫–∏.

    –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç —ç–∫–∑–µ–º–ø–ª—è—Ä EmailMonitor —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç
    –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤—Ö–æ–¥—è—â–∏—Ö –ø–∏—Å–µ–º —á–µ—Ä–µ–∑ IMAP. –õ–æ–≥–∏—Ä—É–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∏ –∫–ª—é—á–µ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è
    (–∑–∞–ø—É—Å–∫, –æ—à–∏–±–∫–∏, –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ). –ü—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç—ã –ø–æ—á—Ç–æ–≤–æ–≥–æ –º–æ–¥—É–ª—è
    –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ø–∞–ø–æ–∫. –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—à–∏–±–∫–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∏ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è
    –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º (Ctrl+C) –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è.

    Returns:
        NoReturn: –§—É–Ω–∫—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ –∏ –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ,
            –∑–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ–º —Å–ª—É—á–∞–µ–≤ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è –∏–ª–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫.

    Raises:
        KeyboardInterrupt: –ü—Ä–∏ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º (Ctrl+C), —á—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç
            –∫ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–º—É –∑–∞–≤–µ—Ä—à–µ–Ω–∏—é.
        Exception: –ü—Ä–∏ –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω—ã—Ö –æ—à–∏–±–∫–∞—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å–±–æ–π IMAP-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è),
            –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è —Å –ø–æ—Å–ª–µ–¥—É—é—â–∏–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ–º.
    """
    # –õ–æ–≥–∏—Ä—É–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –∏ –∫–æ–Ω—Ç—Ä–æ–ª—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
    logger.info(CONFIG.display_config())
    logger.info("–ó–∞–ø—É—â–µ–Ω –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–æ—á—Ç—ã (—Ç–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º)")

    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º EmailMonitor
    email_monitor = EmailMonitor(
        email_user=CONFIG.EMAIL_ADDRESS,
        email_pass=CONFIG.EMAIL_PASSWORD,
        imap_server=CONFIG.imap_server,
        imap_port=CONFIG.imap_port
    )

    try:
        # –ó–∞–ø—É—Å–∫–∞–µ–º –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–æ—á—Ç—ã
        email_monitor.monitor()
    except KeyboardInterrupt:
        email_monitor.stop()
        logger.info("–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–æ—á—Ç—ã –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º")
    except Exception as e:
        # –õ–æ–≥–∏—Ä—É–µ–º –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏ –∏ –∑–∞–≤–µ—Ä—à–∞–µ–º —Ä–∞–±–æ—Ç—É
        logger.error(f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–µ –ø–æ—á—Ç—ã: {e}\n{traceback.format_exc()}")
        raise  # –ü–æ–≤—Ç–æ—Ä–Ω–æ –≤—ã–∑—ã–≤–∞–µ–º –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤—ã–∑—ã–≤–∞—é—â–µ–≥–æ –∫–æ–¥–∞


def test_folder_monitor() -> None:
    """–ó–∞–ø—É—Å–∫–∞–µ—Ç –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–∞–ø–æ–∫ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –æ—Ç–ª–∞–¥–∫–∏.

    –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç —ç–∫–∑–µ–º–ø–ª—è—Ä FolderWatcher –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –ø–∞–ø–∫–µ
    CONFIG.OUT_OCR_FOLDER –∏ –≤—ã–∑—ã–≤–∞–µ—Ç callback-—Ñ—É–Ω–∫—Ü–∏—é process_output_ocr –ø—Ä–∏ —Å–æ–±—ã—Ç–∏—è—Ö
    –∏–ª–∏ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏. –õ–æ–≥–∏—Ä—É–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∏ –∫–ª—é—á–µ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è (–∑–∞–ø—É—Å–∫, –æ—à–∏–±–∫–∏, –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ).
    –ü—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç—ã –º–æ–¥—É–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ø–∞–ø–æ–∫ –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
    –ø–æ—á—Ç—ã. –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—à–∏–±–∫–∏ –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—è –∏ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º (Ctrl+C) –¥–ª—è
    –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è.

    Returns:
        NoReturn: –§—É–Ω–∫—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ –∏ –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ,
            –∑–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ–º —Å–ª—É—á–∞–µ–≤ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è –∏–ª–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫.

    Raises:
        KeyboardInterrupt: –ü—Ä–∏ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º (Ctrl+C), —á—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç
            –∫ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–º—É –∑–∞–≤–µ—Ä—à–µ–Ω–∏—é.
        Exception: –ü—Ä–∏ –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω—ã—Ö –æ—à–∏–±–∫–∞—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å–±–æ–π watchdog),
            –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è —Å –ø–æ—Å–ª–µ–¥—É—é—â–∏–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ–º.
    """
    # –õ–æ–≥–∏—Ä—É–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –∏ –∫–æ–Ω—Ç—Ä–æ–ª—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
    logger.info(CONFIG.display_config())
    logger.info("–ó–∞–ø—É—â–µ–Ω –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–∞–ø–æ–∫ (—Ç–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º)")

    # –°–æ–∑–¥–∞–µ–º –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—å —Å –ø–µ—Ä–µ–¥–∞—á–µ–π callback-—Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è OCR-–æ–±—Ä–∞–±–æ—Ç–∫–∏
    watcher = FolderWatcher(
        folder_path=CONFIG.OUT_OCR_FOLDER,
        callback=lambda: process_output_ocr(
            email_user=CONFIG.EMAIL_ADDRESS,
            email_pass=CONFIG.EMAIL_PASSWORD,
            smtp_server=CONFIG.smtp_server,
            smtp_port=CONFIG.smtp_port,
        )
    )

    try:
        # –ó–∞–ø—É—Å–∫–∞–µ–º –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–∞–ø–∫–∏
        watcher.monitor()
    except KeyboardInterrupt:
        watcher.stop()
        logger.info("–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–∞–ø–æ–∫ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º")
    except Exception as e:
        # –õ–æ–≥–∏—Ä—É–µ–º –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏ –∏ –∑–∞–≤–µ—Ä—à–∞–µ–º —Ä–∞–±–æ—Ç—É
        logger.error(f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–µ –ø–∞–ø–æ–∫: {e}\n{traceback.format_exc()}")
        raise  # –ü–æ–≤—Ç–æ—Ä–Ω–æ –≤—ã–∑—ã–≤–∞–µ–º –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤—ã–∑—ã–≤–∞—é—â–µ–≥–æ –∫–æ–¥–∞


if __name__ == "__main__":
    main()  # –û—Å–Ω–æ–≤–Ω–æ–π —Ä–µ–∂–∏–º (–æ–±–∞ –º–æ–Ω–∏—Ç–æ—Ä–∞ –≤ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –ø–æ—Ç–æ–∫–∞—Ö)
    # main_fallback()  # –ê–≤–∞—Ä–∏–π–Ω—ã–π —Ä–µ–∂–∏–º (–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫ –¥–≤—É—Ö —É–ø—Ä–æ—â–µ–Ω–Ω—ã—Ö –º–æ–¥—É–ª–µ–π –≤ –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–º —Ü–∏–∫–ª–µ)
    # test_email_monitor()  # –¢–µ—Å—Ç —Ç–æ–ª—å–∫–æ –ø–æ—á—Ç—ã
    # test_folder_monitor()  # –¢–µ—Å—Ç —Ç–æ–ª—å–∫–æ –ø–∞–ø–æ–∫
